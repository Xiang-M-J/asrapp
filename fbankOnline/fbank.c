#define _CRT_SECURE_NO_WARNINGS
#include "fbank.h"


float cmvn_means[560] = { -8.311879,-8.600912,-9.615928,-10.43595,-11.21292,-11.88333,-12.36243,-12.63706,-12.8818,-12.83066,-12.89103,-12.95666,-13.19763,-13.40598,-13.49113,-13.5546,-13.55639,-13.51915,-13.68284,-13.53289,-13.42107,-13.65519,-13.50713,-13.75251,-13.76715,-13.87408,-13.73109,-13.70412,-13.56073,-13.53488,-13.54895,-13.56228,-13.59408,-13.62047,-13.64198,-13.66109,-13.62669,-13.58297,-13.57387,-13.4739,-13.53063,-13.48348,-13.61047,-13.64716,-13.71546,-13.79184,-13.90614,-14.03098,-14.18205,-14.35881,-14.48419,-14.60172,-14.70591,-14.83362,-14.92122,-15.00622,-15.05122,-15.03119,-14.99028,-14.92302,-14.86927,-14.82691,-14.7972,-14.76909,-14.71356,-14.61277,-14.51696,-14.42252,-14.36405,-14.30451,-14.23161,-14.19851,-14.16633,-14.15649,-14.10504,-13.99518,-13.79562,-13.3996,-12.7767,-11.71208,-8.311879,-8.600912,-9.615928,-10.43595,-11.21292,-11.88333,-12.36243,-12.63706,-12.8818,-12.83066,-12.89103,-12.95666,-13.19763,-13.40598,-13.49113,-13.5546,-13.55639,-13.51915,-13.68284,-13.53289,-13.42107,-13.65519,-13.50713,-13.75251,-13.76715,-13.87408,-13.73109,-13.70412,-13.56073,-13.53488,-13.54895,-13.56228,-13.59408,-13.62047,-13.64198,-13.66109,-13.62669,-13.58297,-13.57387,-13.4739,-13.53063,-13.48348,-13.61047,-13.64716,-13.71546,-13.79184,-13.90614,-14.03098,-14.18205,-14.35881,-14.48419,-14.60172,-14.70591,-14.83362,-14.92122,-15.00622,-15.05122,-15.03119,-14.99028,-14.92302,-14.86927,-14.82691,-14.7972,-14.76909,-14.71356,-14.61277,-14.51696,-14.42252,-14.36405,-14.30451,-14.23161,-14.19851,-14.16633,-14.15649,-14.10504,-13.99518,-13.79562,-13.3996,-12.7767,-11.71208,-8.311879,-8.600912,-9.615928,-10.43595,-11.21292,-11.88333,-12.36243,-12.63706,-12.8818,-12.83066,-12.89103,-12.95666,-13.19763,-13.40598,-13.49113,-13.5546,-13.55639,-13.51915,-13.68284,-13.53289,-13.42107,-13.65519,-13.50713,-13.75251,-13.76715,-13.87408,-13.73109,-13.70412,-13.56073,-13.53488,-13.54895,-13.56228,-13.59408,-13.62047,-13.64198,-13.66109,-13.62669,-13.58297,-13.57387,-13.4739,-13.53063,-13.48348,-13.61047,-13.64716,-13.71546,-13.79184,-13.90614,-14.03098,-14.18205,-14.35881,-14.48419,-14.60172,-14.70591,-14.83362,-14.92122,-15.00622,-15.05122,-15.03119,-14.99028,-14.92302,-14.86927,-14.82691,-14.7972,-14.76909,-14.71356,-14.61277,-14.51696,-14.42252,-14.36405,-14.30451,-14.23161,-14.19851,-14.16633,-14.15649,-14.10504,-13.99518,-13.79562,-13.3996,-12.7767,-11.71208,-8.311879,-8.600912,-9.615928,-10.43595,-11.21292,-11.88333,-12.36243,-12.63706,-12.8818,-12.83066,-12.89103,-12.95666,-13.19763,-13.40598,-13.49113,-13.5546,-13.55639,-13.51915,-13.68284,-13.53289,-13.42107,-13.65519,-13.50713,-13.75251,-13.76715,-13.87408,-13.73109,-13.70412,-13.56073,-13.53488,-13.54895,-13.56228,-13.59408,-13.62047,-13.64198,-13.66109,-13.62669,-13.58297,-13.57387,-13.4739,-13.53063,-13.48348,-13.61047,-13.64716,-13.71546,-13.79184,-13.90614,-14.03098,-14.18205,-14.35881,-14.48419,-14.60172,-14.70591,-14.83362,-14.92122,-15.00622,-15.05122,-15.03119,-14.99028,-14.92302,-14.86927,-14.82691,-14.7972,-14.76909,-14.71356,-14.61277,-14.51696,-14.42252,-14.36405,-14.30451,-14.23161,-14.19851,-14.16633,-14.15649,-14.10504,-13.99518,-13.79562,-13.3996,-12.7767,-11.71208,-8.311879,-8.600912,-9.615928,-10.43595,-11.21292,-11.88333,-12.36243,-12.63706,-12.8818,-12.83066,-12.89103,-12.95666,-13.19763,-13.40598,-13.49113,-13.5546,-13.55639,-13.51915,-13.68284,-13.53289,-13.42107,-13.65519,-13.50713,-13.75251,-13.76715,-13.87408,-13.73109,-13.70412,-13.56073,-13.53488,-13.54895,-13.56228,-13.59408,-13.62047,-13.64198,-13.66109,-13.62669,-13.58297,-13.57387,-13.4739,-13.53063,-13.48348,-13.61047,-13.64716,-13.71546,-13.79184,-13.90614,-14.03098,-14.18205,-14.35881,-14.48419,-14.60172,-14.70591,-14.83362,-14.92122,-15.00622,-15.05122,-15.03119,-14.99028,-14.92302,-14.86927,-14.82691,-14.7972,-14.76909,-14.71356,-14.61277,-14.51696,-14.42252,-14.36405,-14.30451,-14.23161,-14.19851,-14.16633,-14.15649,-14.10504,-13.99518,-13.79562,-13.3996,-12.7767,-11.71208,-8.311879,-8.600912,-9.615928,-10.43595,-11.21292,-11.88333,-12.36243,-12.63706,-12.8818,-12.83066,-12.89103,-12.95666,-13.19763,-13.40598,-13.49113,-13.5546,-13.55639,-13.51915,-13.68284,-13.53289,-13.42107,-13.65519,-13.50713,-13.75251,-13.76715,-13.87408,-13.73109,-13.70412,-13.56073,-13.53488,-13.54895,-13.56228,-13.59408,-13.62047,-13.64198,-13.66109,-13.62669,-13.58297,-13.57387,-13.4739,-13.53063,-13.48348,-13.61047,-13.64716,-13.71546,-13.79184,-13.90614,-14.03098,-14.18205,-14.35881,-14.48419,-14.60172,-14.70591,-14.83362,-14.92122,-15.00622,-15.05122,-15.03119,-14.99028,-14.92302,-14.86927,-14.82691,-14.7972,-14.76909,-14.71356,-14.61277,-14.51696,-14.42252,-14.36405,-14.30451,-14.23161,-14.19851,-14.16633,-14.15649,-14.10504,-13.99518,-13.79562,-13.3996,-12.7767,-11.71208,-8.311879,-8.600912,-9.615928,-10.43595,-11.21292,-11.88333,-12.36243,-12.63706,-12.8818,-12.83066,-12.89103,-12.95666,-13.19763,-13.40598,-13.49113,-13.5546,-13.55639,-13.51915,-13.68284,-13.53289,-13.42107,-13.65519,-13.50713,-13.75251,-13.76715,-13.87408,-13.73109,-13.70412,-13.56073,-13.53488,-13.54895,-13.56228,-13.59408,-13.62047,-13.64198,-13.66109,-13.62669,-13.58297,-13.57387,-13.4739,-13.53063,-13.48348,-13.61047,-13.64716,-13.71546,-13.79184,-13.90614,-14.03098,-14.18205,-14.35881,-14.48419,-14.60172,-14.70591,-14.83362,-14.92122,-15.00622,-15.05122,-15.03119,-14.99028,-14.92302,-14.86927,-14.82691,-14.7972,-14.76909,-14.71356,-14.61277,-14.51696,-14.42252,-14.36405,-14.30451,-14.23161,-14.19851,-14.16633,-14.15649,-14.10504,-13.99518,-13.79562,-13.3996,-12.7767,-11.71208 };
float cmvn_vars[560] = { 0.155775,0.154484,0.1527379,0.1518718,0.1506028,0.1489256,0.147067,0.1447061,0.1436307,0.1443568,0.1451849,0.1455157,0.1452821,0.1445717,0.1439195,0.1435867,0.1436018,0.1438781,0.1442086,0.1448844,0.1454756,0.145663,0.146268,0.1467386,0.1472724,0.147664,0.1480913,0.1483739,0.1488841,0.1493636,0.1497088,0.1500379,0.1502916,0.1505389,0.1506787,0.1507102,0.1505992,0.1505445,0.1505938,0.1508133,0.1509569,0.1512396,0.1514625,0.1516195,0.1516156,0.1515561,0.1514966,0.1513976,0.1512612,0.151076,0.1510596,0.1510431,0.151077,0.1511168,0.1511917,0.151023,0.1508045,0.1505885,0.1503493,0.1502373,0.1501726,0.1500762,0.1500065,0.1499782,0.150057,0.1502658,0.150469,0.1505335,0.1505505,0.1505328,0.1504275,0.1502438,0.1499674,0.1497118,0.1494661,0.1493102,0.1493681,0.1495501,0.1499738,0.1509654,0.155775,0.154484,0.1527379,0.1518718,0.1506028,0.1489256,0.147067,0.1447061,0.1436307,0.1443568,0.1451849,0.1455157,0.1452821,0.1445717,0.1439195,0.1435867,0.1436018,0.1438781,0.1442086,0.1448844,0.1454756,0.145663,0.146268,0.1467386,0.1472724,0.147664,0.1480913,0.1483739,0.1488841,0.1493636,0.1497088,0.1500379,0.1502916,0.1505389,0.1506787,0.1507102,0.1505992,0.1505445,0.1505938,0.1508133,0.1509569,0.1512396,0.1514625,0.1516195,0.1516156,0.1515561,0.1514966,0.1513976,0.1512612,0.151076,0.1510596,0.1510431,0.151077,0.1511168,0.1511917,0.151023,0.1508045,0.1505885,0.1503493,0.1502373,0.1501726,0.1500762,0.1500065,0.1499782,0.150057,0.1502658,0.150469,0.1505335,0.1505505,0.1505328,0.1504275,0.1502438,0.1499674,0.1497118,0.1494661,0.1493102,0.1493681,0.1495501,0.1499738,0.1509654,0.155775,0.154484,0.1527379,0.1518718,0.1506028,0.1489256,0.147067,0.1447061,0.1436307,0.1443568,0.1451849,0.1455157,0.1452821,0.1445717,0.1439195,0.1435867,0.1436018,0.1438781,0.1442086,0.1448844,0.1454756,0.145663,0.146268,0.1467386,0.1472724,0.147664,0.1480913,0.1483739,0.1488841,0.1493636,0.1497088,0.1500379,0.1502916,0.1505389,0.1506787,0.1507102,0.1505992,0.1505445,0.1505938,0.1508133,0.1509569,0.1512396,0.1514625,0.1516195,0.1516156,0.1515561,0.1514966,0.1513976,0.1512612,0.151076,0.1510596,0.1510431,0.151077,0.1511168,0.1511917,0.151023,0.1508045,0.1505885,0.1503493,0.1502373,0.1501726,0.1500762,0.1500065,0.1499782,0.150057,0.1502658,0.150469,0.1505335,0.1505505,0.1505328,0.1504275,0.1502438,0.1499674,0.1497118,0.1494661,0.1493102,0.1493681,0.1495501,0.1499738,0.1509654,0.155775,0.154484,0.1527379,0.1518718,0.1506028,0.1489256,0.147067,0.1447061,0.1436307,0.1443568,0.1451849,0.1455157,0.1452821,0.1445717,0.1439195,0.1435867,0.1436018,0.1438781,0.1442086,0.1448844,0.1454756,0.145663,0.146268,0.1467386,0.1472724,0.147664,0.1480913,0.1483739,0.1488841,0.1493636,0.1497088,0.1500379,0.1502916,0.1505389,0.1506787,0.1507102,0.1505992,0.1505445,0.1505938,0.1508133,0.1509569,0.1512396,0.1514625,0.1516195,0.1516156,0.1515561,0.1514966,0.1513976,0.1512612,0.151076,0.1510596,0.1510431,0.151077,0.1511168,0.1511917,0.151023,0.1508045,0.1505885,0.1503493,0.1502373,0.1501726,0.1500762,0.1500065,0.1499782,0.150057,0.1502658,0.150469,0.1505335,0.1505505,0.1505328,0.1504275,0.1502438,0.1499674,0.1497118,0.1494661,0.1493102,0.1493681,0.1495501,0.1499738,0.1509654,0.155775,0.154484,0.1527379,0.1518718,0.1506028,0.1489256,0.147067,0.1447061,0.1436307,0.1443568,0.1451849,0.1455157,0.1452821,0.1445717,0.1439195,0.1435867,0.1436018,0.1438781,0.1442086,0.1448844,0.1454756,0.145663,0.146268,0.1467386,0.1472724,0.147664,0.1480913,0.1483739,0.1488841,0.1493636,0.1497088,0.1500379,0.1502916,0.1505389,0.1506787,0.1507102,0.1505992,0.1505445,0.1505938,0.1508133,0.1509569,0.1512396,0.1514625,0.1516195,0.1516156,0.1515561,0.1514966,0.1513976,0.1512612,0.151076,0.1510596,0.1510431,0.151077,0.1511168,0.1511917,0.151023,0.1508045,0.1505885,0.1503493,0.1502373,0.1501726,0.1500762,0.1500065,0.1499782,0.150057,0.1502658,0.150469,0.1505335,0.1505505,0.1505328,0.1504275,0.1502438,0.1499674,0.1497118,0.1494661,0.1493102,0.1493681,0.1495501,0.1499738,0.1509654,0.155775,0.154484,0.1527379,0.1518718,0.1506028,0.1489256,0.147067,0.1447061,0.1436307,0.1443568,0.1451849,0.1455157,0.1452821,0.1445717,0.1439195,0.1435867,0.1436018,0.1438781,0.1442086,0.1448844,0.1454756,0.145663,0.146268,0.1467386,0.1472724,0.147664,0.1480913,0.1483739,0.1488841,0.1493636,0.1497088,0.1500379,0.1502916,0.1505389,0.1506787,0.1507102,0.1505992,0.1505445,0.1505938,0.1508133,0.1509569,0.1512396,0.1514625,0.1516195,0.1516156,0.1515561,0.1514966,0.1513976,0.1512612,0.151076,0.1510596,0.1510431,0.151077,0.1511168,0.1511917,0.151023,0.1508045,0.1505885,0.1503493,0.1502373,0.1501726,0.1500762,0.1500065,0.1499782,0.150057,0.1502658,0.150469,0.1505335,0.1505505,0.1505328,0.1504275,0.1502438,0.1499674,0.1497118,0.1494661,0.1493102,0.1493681,0.1495501,0.1499738,0.1509654,0.155775,0.154484,0.1527379,0.1518718,0.1506028,0.1489256,0.147067,0.1447061,0.1436307,0.1443568,0.1451849,0.1455157,0.1452821,0.1445717,0.1439195,0.1435867,0.1436018,0.1438781,0.1442086,0.1448844,0.1454756,0.145663,0.146268,0.1467386,0.1472724,0.147664,0.1480913,0.1483739,0.1488841,0.1493636,0.1497088,0.1500379,0.1502916,0.1505389,0.1506787,0.1507102,0.1505992,0.1505445,0.1505938,0.1508133,0.1509569,0.1512396,0.1514625,0.1516195,0.1516156,0.1515561,0.1514966,0.1513976,0.1512612,0.151076,0.1510596,0.1510431,0.151077,0.1511168,0.1511917,0.151023,0.1508045,0.1505885,0.1503493,0.1502373,0.1501726,0.1500762,0.1500065,0.1499782,0.150057,0.1502658,0.150469,0.1505335,0.1505505,0.1505328,0.1504275,0.1502438,0.1499674,0.1497118,0.1494661,0.1493102,0.1493681,0.1495501,0.1499738,0.1509654 };


void WavFrontend(float * s, float ** o, int sampleNum) {
	srand((unsigned)time(NULL));
	float sampleFrequency = 16000;
	float samplePeriod = (float)1e7 / sampleFrequency;
	float hipassfre = sampleFrequency / 2.0;
	float lowpassfre = 20.0;
	int wlen = 25 * 16;
	int inc = 10 * 16;
	int bankNum = 80;	
	int fftLength = 512;
	float dither = 0.0;
	float preemphasise = 0.97;
	int m = 1 + (sampleNum - wlen) / inc;    // fbank ʱ��ά�ȵĳ���
	int lfr_m = 7, lfr_n = 6;
	
	Vector d2 = NULL, fbank=NULL, hamWin = NULL;
	FBankInfo info;
	int i, j;

	d2 = CreateVector(wlen);

	info = InitFBank(wlen, samplePeriod, bankNum, lowpassfre, hipassfre, 1, 1, 0, 1.0, 0, 0);
	//��ʼ��������wlen���������=(10E7/16000),bankNum,���Ƶ��,���Ƶ��,�Ƿ�����������Ƿ��log���Ƿ�floatfft���Ƿ�resacle(1.0������)
	//����ham��
	hamWin = GenHamWindow(wlen);
	fbank = CreateVector(bankNum);

	float** fbank_data = NULL;
	fbank_data = (float **)malloc(sizeof(float*) * m);

	for (size_t i = 0; i < m; i++)
	{
		fbank_data[i] = (float*)malloc(sizeof(float) * bankNum);
		for (size_t j = 0; j < bankNum; j++)
		{
			fbank_data[i][j] = 0.0;
		}
	}
	
	int i_ = 0;

	for (j = 0; j <= (sampleNum - wlen); j += inc) {
		
		// �����Ŷ�
		for (size_t i = 0; i < wlen; i++) {
			// d2[i + 1] = s[i + j] + dither * random_gaussian();
			d2[i + 1] = s[i + j];
		}

		// ȥ��ֱ������
		float d2_mean = cal_mean(d2, wlen);
		for (size_t i = 1; i <= wlen; i++)
		{
			d2[i] -= d2_mean;
		}

		// ��ȡ��������
		float signal_log_energy = cal_energy(d2, wlen);
		
		// Ԥ��ǿ
		PreEmphasise(d2, preemphasise);

		//�Ӵ�
		Ham(d2, hamWin, wlen);

		//te��te2�ֱ��Ǹ����źź�fft����źż��������
		//����mel�˲�����
		Wave2FBank2(d2, fbank, info);
		for (size_t k = 0; k < bankNum; k++)
		{
			fbank_data[i_][k] = fbank[k + 1];
		}
		//printf("\n");
		i_++;
	}
	//SubtractColumnMean(o, bankNum, m);

	apply_lfr(fbank_data, o, lfr_m, lfr_n, m, bankNum);
	
	for (size_t i = 0; i < m; i++)
	{
		free(fbank_data[i]);
	}
	free(fbank_data);
	int axis1 = (int)ceil(m / (lfr_n*1.0));
	int axis2 = lfr_m * bankNum;
	apply_cmvn(o, axis1, axis2);
	FreeVector(d2);
	FreeVector(fbank);
	FreeVector(hamWin);
	
	//system("pause");
	return;
}

void WavFrontendOnline(float * s, float ** o, int sampleNum) {
	srand((unsigned)time(NULL));
	float sampleFrequency = 16000;
	float samplePeriod = (float)1e7 / sampleFrequency;
	float hipassfre = sampleFrequency / 2.0;
	float lowpassfre = 20.0;
	int wlen = 25 * 16;
	int inc = 10 * 16;
	int bankNum = 80;	
	int fftLength = 512;
	float preemphasise = 0.97;
	int m = 1 + (int)((sampleNum - wlen) / inc);    // fbank 时间维度的长度
	int lfr_m = 5, lfr_n = 1;
	
	Vector d2 = NULL, fbank=NULL, hamWin = NULL;
	FBankInfo info;
	int i, j;

	d2 = CreateVector(wlen);

	info = InitFBank(wlen, samplePeriod, bankNum, lowpassfre, hipassfre, 1, 1, 0, 1.0, 0, 0);
	//初始化，其中wlen，采样间隔=(10E7/16000),bankNum,最低频率,最高频率,是否计算能量，是否加log，是否doublefft，是否resacle(1.0不进行)
	//产生ham窗
	hamWin = GenHamWindow(wlen);
	fbank = CreateVector(bankNum);

	float** fbank_data = NULL;
	fbank_data = (float **)malloc(sizeof(float*) * m);

	for (size_t i = 0; i < m; i++)
	{
		fbank_data[i] = (float*)malloc(sizeof(float) * bankNum);
		for (size_t j = 0; j < bankNum; j++)
		{
			fbank_data[i][j] = 0.0;
		}
	}
	
	int i_ = 0;

	for (j = 0; j <= (sampleNum - wlen); j += inc) {
		
		// 加上扰动
		for (size_t i = 0; i < wlen; i++) {
			d2[i + 1] = s[i + j];
		}

		// 去除直流分量
		float d2_mean = cal_mean(d2, wlen);
		for (size_t i = 1; i <= wlen; i++)
		{
			d2[i] -= d2_mean;
		}

		// 获取对数能量
		float signal_log_energy = cal_energy(d2, wlen);
		
		// 预增强
		PreEmphasise(d2, preemphasise);

		//加窗
		Ham(d2, hamWin, wlen);

		//te和te2分别是根据信号和fft后的信号计算的能量
		//经过mel滤波器组
		Wave2FBank2(d2, fbank, info);
		for (size_t k = 0; k < bankNum; k++)
		{
			fbank_data[i_][k] = fbank[k + 1];
		}
		//printf("\n");
		i_++;
	}
	//SubtractColumnMean(o, bankNum, m);

	apply_lfr_online(fbank_data, o, lfr_m, lfr_n, m, bankNum);
	
	for (size_t i = 0; i < m; i++)
	{
		free(fbank_data[i]);
	}
	free(fbank_data);
	int m_lfm = (int)((lfr_m - 1) / 2);
	int axis1 = (int) m / lfr_n;
	int axis2 = lfr_m * bankNum;
	apply_cmvn(o, axis1, axis2);
	FreeVector(d2);
	FreeVector(fbank);
	FreeVector(hamWin);
	
	//system("pause");
	return;
}

float random_gaussian() {
	float u1 = rand() * 1.0f / RAND_MAX;
	float u2 = rand() * 1.0f / RAND_MAX;
	float z = sqrt(-2 * log(u1)) * cos(2 * pi * u2);   // z ~ U(0, 1)
	//float y = 1.0 + 2.0 * z;
	return z;
}

float cal_mean(Vector data, int wlen)
{
	float sum = 0.;
	for (size_t i = 1; i <= wlen; i++)
	{
		sum += data[i];
	}
	return sum / wlen;
}

float cal_energy(Vector data, int wlen)
{
	float energy = 0.0;
	for (size_t i = 1; i <= wlen; i++)
	{
		energy += (data[i] * data[i]);
	}
	if (energy < EPSILON)
	{
		energy = EPSILON;
	}
	float log_energy = log(energy);
	return log_energy;
}


void SubtractColumnMean(float** data, int axis1, int axis2) {
	float time_mean = 0.;
	for (size_t i = 0; i < axis1; i++)   // num_of_bins
	{
		time_mean = 0.;
		for (size_t j = 0; j < axis2; j++)  // time steps
		{
			time_mean += data[j][i];
		}
		time_mean /= axis2;
		for (size_t j = 0; j < axis2; j++)  // time steps
		{
			data[j][i] -= time_mean;
		}
	}
}

void apply_lfr(float** data, float **output, int lfr_m, int lfr_n, int m, int bankNum)
{
	int m_lfr = (int)ceil(m / (lfr_n * 1.0));
	int m_lfm = (int)((lfr_m - 1) / 2);

	// �ȴ�����һ�� m_lfm �� data[0]  + data[0: lfr_m - m_lfm]
	for (size_t i = 0; i < m_lfm; i++)
	{
		for (size_t j = 0; j < bankNum; j++)
		{
			output[0][i * bankNum + j] = data[0][j];
		}
	}
	for (size_t i = 0; i < lfr_m - m_lfm; i++)
	{
		for (size_t j = 0; j < bankNum; j++)
		{
			output[0][m_lfm * bankNum + i * bankNum + j] = data[i][j];
		}
	}
	
	// �ٴ����м��

	for (size_t i = 1; i < m_lfr; i++)
	{
		if (lfr_m <= m + m_lfm - i * lfr_n)
		{
			int l_ = i * lfr_n - m_lfm;
			for (size_t j = l_; j < l_ + lfr_m; j++)
			{
				for (size_t k = 0; k < bankNum; k++)
				{
					output[i][(j-l_) * bankNum + k] = data[j][k];
				}
			}
		}
		else
		{
			// �������һ�У�ʹ�����һ�н��в���
			int num_padding = lfr_m - (m + m_lfm - i * lfr_n);

			int l_ = i * lfr_n - m_lfm;
			for (size_t j = i * lfr_n - m_lfm; j < m; j++)
			{
				for (size_t k = 0; k < bankNum; k++)
				{
					output[i][(j-l_) * bankNum + k] = data[j][k];
				}
			}
			int filled_num = (m - (i * lfr_n - m_lfm)) * bankNum;
			for (size_t j = 0; j < num_padding; j++)
			{
				for (size_t k = 0; k < bankNum; k++)
				{
					output[i][filled_num + j * bankNum + k] = data[m - 1][k];
				}
			}
		}
	}
}

void apply_lfr_online(float** data, float **output, int lfr_m, int lfr_n, int m, int bankNum)
{
	int m_lfm = (int)((lfr_m - 1) / 2);
	int m_lfr = (int)ceil(m + m_lfm - (int)((lfr_m - 1) / 2) / (lfr_n * 1.0));

	// 先处理第一行 m_lfm 个 data[0]  + data[0: lfr_m - m_lfm]
	for (size_t i = 0; i < m_lfm; i++)
	{
		for (size_t j = 0; j < bankNum; j++)
		{
			output[0][i * bankNum + j] = data[0][j];
		}
	}
	for (size_t i = 0; i < lfr_m - m_lfm; i++)
	{
		for (size_t j = 0; j < bankNum; j++)
		{
			output[0][m_lfm * bankNum + i * bankNum + j] = data[i][j];
		}
	}
	for (size_t i = 0; i < m_lfm - lfr_n; i++)
	{
		for (size_t j = 0; j < bankNum; j++)
		{
			output[1][i * bankNum + j] = data[0][j];
		}
	}
	for (size_t i = 0; i < lfr_m - m_lfm + lfr_n; i++)
	{
		for (size_t j = 0; j < bankNum; j++)
		{
			output[1][(m_lfm - lfr_n)*bankNum + i * bankNum + j] = data[i][j];
		}
	}


	// 再处理中间的

	for (size_t i = 2; i < m_lfr; i++)
	{
		if (lfr_m <= m + m_lfm - i * lfr_n)
		{
			int l_ = i * lfr_n - m_lfm;
			for (size_t j = l_; j < l_ + lfr_m; j++)
			{
				for (size_t k = 0; k < bankNum; k++)
				{
					output[i][(j-l_) * bankNum + k] = data[j][k];
				}
			}
		}
		else
		{
			// 处理最后一行，使用最后一列进行补齐
			int num_padding = lfr_m - (m + m_lfm - i * lfr_n);

			int l_ = i * lfr_n - m_lfm;
			for (size_t j = i * lfr_n - m_lfm; j < m; j++)
			{
				for (size_t k = 0; k < bankNum; k++)
				{
					output[i][(j-l_) * bankNum + k] = data[j][k];
				}
			}
			int filled_num = (m - (i * lfr_n - m_lfm)) * bankNum;
			for (size_t j = 0; j < num_padding; j++)
			{
				for (size_t k = 0; k < bankNum; k++)
				{
					output[i][filled_num + j * bankNum + k] = data[m - 1][k];
				}
			}
		}
	}
}


float** create2dVector(int axis1, int axis2) {
	float** vector;
	vector = (float**)malloc(sizeof(float*) * axis1);

	for (size_t i = 0; i < axis1; i++)
	{
		*(vector + i) = (float*)malloc(sizeof(float) * axis2);
	}
	return vector;
}

void free2dVector(float** vector, int axis1) {
	for (size_t i = 0; i < axis1; i++)
	{
		free(vector[i]);
	}
	//free(vector);
}

void apply_cmvn(float** data, int axis1, int axis2) {
	for (size_t i = 0; i < axis1; i++)
	{
		for (size_t j = 0; j < axis2; j++)
		{
			data[i][j] += cmvn_means[j];
			data[i][j] *= cmvn_vars[j];
		}
	}
}